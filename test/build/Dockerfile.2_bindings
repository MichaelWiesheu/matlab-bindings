FROM precice_mpich

# Get MATLAB bindings, ensuring that if the github repo changes, the cloning is done again 
# (https://stackoverflow.com/questions/36996046/how-to-prevent-dockerfile-caching-git-clone)
ARG branch=develop
ADD https://api.github.com/repos/precice/matlab-bindings/git/refs/heads/${branch} /matlab_bindings_version.json
RUN git clone --branch $branch https://github.com/precice/matlab-bindings.git /home/precice/matlab-bindings

# Compile MATLAB bindings and add them to the path
ENV MATLAB_INSTALL="/home/precice/MATLAB/"
WORKDIR /home/precice/matlab-bindings/
RUN $MATLAB_INSTALL/bin/matlab -nodisplay -nosplash -nodesktop -r "run('compile_matlab_bindings_for_precice.m');exit;" | tail -n +11
ENV BINDINGS="/home/precice/matlab-bindings/"
ENV MATLABPATH=${BINDINGS}

# Go into solver dummy path and set environment
ENV SOLVER_DUMMY_PATH="$BINDINGS/solverdummy"
WORKDIR ${SOLVER_DUMMY_PATH}
ENV LD_PRELOAD="/usr/lib/x86_64-linux-gnu/libstdc++.so.6"

# Run and test dummies
RUN $MATLAB_INSTALL/bin/matlab -nodisplay -nosplash -nodesktop -r "solverdummy precice-config.xml SolverOne MeshOne;exit;" \
    & $MATLAB_INSTALL/bin/matlab -nodisplay -nosplash -nodesktop -r "solverdummy precice-config.xml SolverTwo MeshTwo;exit;"
RUN test -f precice-SolverOne-iterations.log && \
    test -f precice-SolverOne-events.json && \
    test -f precice-SolverTwo-convergence.log && \
    test -f precice-SolverTwo-events.json && \
    test -f precice-SolverTwo-iterations.log && \
    test -d precice-run

# Set tutorial path
ENV TUTORIAL_PATH="$BINDINGS/tutorial"

# Run and test tutorial with explicit coupling
WORKDIR $TUTORIAL_PATH/explicit
RUN $MATLAB_INSTALL/bin/matlab -nodisplay -nosplash -nodesktop -r "Solver_I;exit;" \
    & $MATLAB_INSTALL/bin/matlab -nodisplay -nosplash -nodesktop -r "Solver_U;exit;"
RUN test -f precice-SolverI-iterations.log && \
    test -f precice-SolverI-events.json && \
    test -f precice-SolverU-convergence.log && \
    test -f precice-SolverU-events.json && \
    test -f precice-SolverU-iterations.log && \
    test -d precice-run && \
    test -f outputs.mat

# Run and test tutorial with implicit coupling
WORKDIR $TUTORIAL_PATH/implicit
RUN $MATLAB_INSTALL/bin/matlab -nodisplay -nosplash -nodesktop -r "Solver_I;exit;" \
    & $MATLAB_INSTALL/bin/matlab -nodisplay -nosplash -nodesktop -r "Solver_U;exit;"
RUN test -f precice-SolverI-iterations.log && \
    test -f precice-SolverI-events.json && \
    test -f precice-SolverU-convergence.log && \
    test -f precice-SolverU-events.json && \
    test -f precice-SolverU-iterations.log && \
    test -d precice-run && \
    test -f outputs.mat
